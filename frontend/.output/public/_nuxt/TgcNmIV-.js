var P=15e3,S=1e3,A=60*S,w=60*A,C=24*w,D="http://www.topografix.com/GPX/gpx_style/0/2",F=new L.Icon.Default,G={startIcon:F,endIcon:F,wptIcons:{"":F},wptTypeIcons:{"":F},pointMatchers:[]},U={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},X={color:"blue"},R={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||P,e.markers=this._merge_objs(G,e.markers||{}),e.marker_options=this._merge_objs(U,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(R,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="";t>=C&&(n+=Math.floor(t/C)+"d ",t=t%C),t>=w&&(n+=Math.floor(t/w)+":",t=t%w);var i=Math.floor(t/A);t=t%A,i<10&&(n+="0"),n+=i+"'";var r=Math.floor(t/S);return t=t%S,r<10&&(n+="0"),n+=r,!e&&t>0?n+="."+Math.round(Math.floor(t)*1e3)/1e3:n+='"',n},get_duration_string_iso:function(t,e){var n=this.get_duration_string(t,e);return n.replace("'",":").replace('"',"")},_toFixed_helper:function(t,e=0){return typeof t=="number"?t.toFixed(e):"?"},to_miles:function(t){return t/1.60934},to_ft:function(t){return t*3.28084},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return t*3.6},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/(3600*1e3))},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/(3600*1e3))},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/(3600*1e3))},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/(3600*1e3))},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,i){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(i,0)+" m"})})},get_elevation_data_imp:function(){var t=this;return this._info.elevation._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.to_ft,function(n,i){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(i,0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,t.ms_to_kmh,function(n,i){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(i,2)+" km/h"})})},get_speed_data_imp:function(){var t=this;return this._info.speed._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,t.ms_to_mih,function(n,i){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(i,2)+" mi/h"})})},get_speed_max:function(){return this.m_to_km(this._info.speed.max)*3600},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,i){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(i,0)+" bpm"})})},get_heartrate_data_imp:function(){var t=this;return this._info.hr._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,i){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(i,0)+" bpm"})})},get_cadence_data:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,i){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(i,0)+" rpm"})})},get_temp_data:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_km,null,function(n,i){return t._toFixed_helper(n,2)+" km, "+t._toFixed_helper(i,0)+" degrees"})})},get_cadence_data_imp:function(){var t=this;return this._info.cad._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,i){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(i,0)+" rpm"})})},get_temp_data_imp:function(){var t=this;return this._info.atemp._points.map(function(e){return t._prepare_data_point(e,t.m_to_mi,null,function(n,i){return t._toFixed_helper(n,2)+" mi, "+t._toFixed_helper(i,0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n={};for(var i in t)n[i]=t[i];for(var i in e)n[i]=e[i];return n},_prepare_data_point:function(t,e,n,i){var r=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return r.push(i&&i(r[0],r[1])||r[0]+": "+r[1]),r},_prepare_markers:function(t){function e(n){return new L.GPXTrackIcon({iconUrl:n})}return Object.entries(t).forEach(([n,i])=>{n==="wptIcons"||n==="wptTypeIcons"?t[n]=this._prepare_markers(i):n==="pointMatchers"?t[n]=i.map(r=>(typeof r.icon=="string"&&(r.icon=e(r.icon)),r)):typeof i=="string"?t[n]=e(i):typeof i=="object"&&i!==null&&(t[n]=i)}),t},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,i){i==null&&(i=this.options.async),n==null&&(n=this.options);var r=this,a=new window.XMLHttpRequest;a.open("GET",t,i);try{a.overrideMimeType("text/xml")}catch{}a.onloadend=function(){a.status==200?e(a.responseXML,n):r.fire("error",{err:"Error fetching resource: "+t})},a.send(null)},_parse:function(t,e,n){var i=this,r=function(h,m){var f=i._parse_gpx_data(h,m);if(!f){i.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(m.gpx_options.parseElements)});return}i.addLayer(f),i.fire("loaded",{layers:f,element:h})};if(t.substr(0,1)==="<"){var a=new DOMParser;n?setTimeout(function(){r(a.parseFromString(t,"text/xml"),e)}):r(a.parseFromString(t,"text/xml"),e)}else this._load_xml(t,r,e,n)},_parse_gpx_data:function(t,e){var n,i,r=[],a=t.getElementsByTagName("name");a.length>0&&(this._info.name=a[0].textContent);var h=t.getElementsByTagName("desc");h.length>0&&(this._info.desc=h[0].textContent);var m=t.getElementsByTagName("author");m.length>0&&(this._info.author=m[0].textContent);var f=t.getElementsByTagName("copyright");f.length>0&&(this._info.copyright=f[0].textContent);var l=e.gpx_options.parseElements;if(l.indexOf("route")>-1){var _=t.getElementsByTagName("rte");for(n=0;n<_.length;n++){var s=_[n],o=this._extract_styling(s),p=this._get_polyline_options(e.polyline_options,n);r=r.concat(this._parse_segment(_[n],e,o,p,"rtept"))}}if(l.indexOf("track")>-1){var d=t.getElementsByTagName("trk");for(n=0;n<d.length;n++){var v=d[n],o=this._extract_styling(v),p=this._get_polyline_options(e.polyline_options,n);if(e.gpx_options.joinTrackSegments)r=r.concat(this._parse_segment(v,e,o,p,"trkpt"));else{var k=v.getElementsByTagName("trkseg");for(u=0;u<k.length;u++)r=r.concat(this._parse_segment(k[u],e,o,p,"trkpt"))}}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),l.indexOf("waypoint")>-1)for(i=t.getElementsByTagName("wpt"),n=0;n<i.length;n++){var T=new L.LatLng(i[n].getAttribute("lat"),i[n].getAttribute("lon")),c=i[n].getElementsByTagName("name"),a=c.length>0?c[0].textContent:"",N=i[n].getElementsByTagName("desc"),h=N.length>0?N[0].textContent:"",g=i[n].getElementsByTagName("sym"),E=g.length>0?g[0].textContent:null,O=i[n].getElementsByTagName("type"),M=O.length>0?O[0].textContent:null,x=e.markers.wptIcons,B=e.markers.wptTypeIcons,b=e.markers.pointMatchers||[],y;if(x&&E&&x[E])y=x[E];else if(B&&M&&B[M])y=B[M];else if(b.length>0){for(var u=0;u<b.length;u++)if(b[u].regex.test(a)){y=b[u].icon;break}}else x&&x[""]&&(y=x[""]);if(!y){console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",E,M,a,i[n]);continue}var I=new L.Marker(T,{clickable:e.marker_options.clickable,title:a,icon:y,type:"waypoint"});I.bindPopup("<b>"+a+"</b>"+(h.length>0?"<br>"+h:"")).openPopup(),this.fire("addpoint",{point:I,point_type:"waypoint",element:i[n]}),r.push(I)}if(r.length>1)return new L.FeatureGroup(r);if(r.length==1)return r[0]},_parse_segment:function(t,e,n,i,r){var a=t.getElementsByTagName(r);if(!a.length)return[];for(var h=[],m=[],f=[],l=null,_=0;_<a.length;_++){var s,o=new L.LatLng(a[_].getAttribute("lat"),a[_].getAttribute("lon"));o.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},s=a[_].getElementsByTagName("time"),s.length>0?o.meta.time=new Date(Date.parse(s[0].textContent)):o.meta.time=new Date("1970-01-01T00:00:00");var p=l!=null?Math.abs(o.meta.time-l.meta.time):0;s=a[_].getElementsByTagName("ele"),s.length>0?o.meta.ele=parseFloat(s[0].textContent):o.meta.ele=l!=null?l.meta.ele:null;var d=l!=null?o.meta.ele-l.meta.ele:0,v=l!=null?this._dist3d(l,o):0;if(s=a[_].getElementsByTagName("speed"),s.length>0?o.meta.speed=parseFloat(s[0].textContent):o.meta.speed=p>0?1e3*v/p:0,s=a[_].getElementsByTagName("name"),s.length>0){for(var k=s[0].textContent,T=e.markers.pointMatchers||[],c=0;c<T.length;c++)if(T[c].regex.test(k)){m.push({label:k,coords:o,icon:T[c].icon,element:a[_]});break}}this._info.length+=v,s=a[_].getElementsByTagNameNS("*","hr"),s.length>0&&(o.meta.hr=parseInt(s[0].textContent),this._info.hr._points.push([this._info.length,o.meta.hr]),this._info.hr._total+=o.meta.hr),s=a[_].getElementsByTagNameNS("*","cad"),s.length>0&&(o.meta.cad=parseInt(s[0].textContent),this._info.cad._points.push([this._info.length,o.meta.cad]),this._info.cad._total+=o.meta.cad),s=a[_].getElementsByTagNameNS("*","atemp"),s.length>0&&(o.meta.atemp=parseInt(s[0].textContent),this._info.atemp._points.push([this._info.length,o.meta.atemp]),this._info.atemp._total+=o.meta.atemp),o.meta.ele>this._info.elevation.max&&(this._info.elevation.max=o.meta.ele),o.meta.ele<this._info.elevation.min&&(this._info.elevation.min=o.meta.ele),this._info.elevation._points.push([this._info.length,o.meta.ele]),o.meta.speed>this._info.speed.max&&(this._info.speed.max=o.meta.speed),this._info.speed._points.push([this._info.length,o.meta.speed]),l==null&&this._info.duration.start==null&&(this._info.duration.start=o.meta.time),this._info.duration.end=o.meta.time,this._info.duration.total+=p,p<e.max_point_interval&&(this._info.duration.moving+=p),d>0?this._info.elevation.gain+=d:this._info.elevation.loss+=Math.abs(d),l=o,h.push(o)}var N=new L.Polyline(h,this._extract_styling(t,n,i));if(this.fire("addline",{line:N,element:t}),f.push(N),e.markers.startIcon){var g=new L.Marker(h[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon});this.fire("addpoint",{point:g,point_type:"start",element:a[0],line:t}),f.push(g)}if(e.markers.endIcon){var g=new L.Marker(h[h.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon});this.fire("addpoint",{point:g,point_type:"end",element:a[a.length-1],line:t}),f.push(g)}for(var _=0;_<m.length;_++){var g=new L.Marker(m[_].coords,{clickable:e.marker_options.clickable,title:m[_].label,icon:m[_].icon});this.fire("addpoint",{point:g,point_type:"label",element:m[_].element}),f.push(g)}return f},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var i=this._merge_objs(X,e),r=t.getElementsByTagNameNS(D,"line");if(r.length>0){var a=r[0].getElementsByTagName("color");a.length>0&&(i.color="#"+a[0].textContent);var a=r[0].getElementsByTagName("opacity");a.length>0&&(i.opacity=a[0].textContent);var a=r[0].getElementsByTagName("weight");a.length>0&&(i.weight=a[0].textContent);var a=r[0].getElementsByTagName("linecap");a.length>0&&(i.lineCap=a[0].textContent);var a=r[0].getElementsByTagName("linejoin");a.length>0&&(i.lineJoin=a[0].textContent);var a=r[0].getElementsByTagName("dasharray");a.length>0&&(i.dashArray=a[0].textContent);var a=r[0].getElementsByTagName("dashoffset");a.length>0&&(i.dashOffset=a[0].textContent)}return this._merge_objs(i,n)},_dist2d:function(t,e){var n=6371e3,i=this._deg2rad(e.lat-t.lat),r=this._deg2rad(e.lng-t.lng),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(r/2)*Math.sin(r/2),h=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),m=n*h;return m},_dist3d:function(t,e){var n=this._dist2d(t,e),i=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(i,2))},_deg2rad:function(t){return t*Math.PI/180}});
